x-shared-env: &shared-env
  APP_ENV: production
  CLIENT_ID: client-id-example
  SESSION_COOKIE_NAME: session
  PORT: 8080
  DB_HOST: db
  DB_PORT: 5432
  DB_DATABASE: dbname
  DB_USER: dbuser
  DB_PASSWORD: dbpassword
  DB_SCHEMA: public
  REDIS_HOST: redis
  REDIS_PORT: 6379
  REDIS_PASSWORD: redispassword
  MINIO_BUCKET_NAME: librarease
  MINIO_BUCKET_TEMP_PATH: temp
  MINIO_BUCKET_PUBLIC_PATH: public
  MINIO_ENDPOINT: assets.librarease.org
  MINIO_ACCESS_KEY: minioaccesskey
  MINIO_SECRET_KEY: miniosecretkey
  FIREBASE_SERVICE_ACCOUNT_KEY_PATH: path-to-firebase-adminsdk.json
  SMTP_HOST: sandbox.smtp.mailtrap.io
  SMTP_PORT: 2525
  SMTP_USERNAME: smtpusername
  SMTP_PASSWORD: smtppassword
  OTEL_EXPORTER_OTLP_ENDPOINT: https://otlp-gateway-prod-ap-southeast-1.grafana.net/otlp
  OTEL_EXPORTER_OTLP_HEADERS: Authorization=Basic base64encodedstring

services:
  db:
    restart: always
    image: postgres:16-alpine
    container_name: db
    shm_size: 256mb
    networks:
      - internal_network
    volumes:
      - /home/ubuntu/librarease/postgres16:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=dbpassword
      - POSTGRES_DB=librarease
    ports: 
      - 5433:5432

  redis:
    restart: always
    image: redis:alpine
    container_name: redis
    networks:
      - internal_network
    volumes:
      - /home/ubuntu/librarease/redis:/data
    command: redis-server --appendonly yes --requirepass redispassword
    

  api-service:
    restart: always
    image: ecr-repo-url/libraraease:backend
    container_name: api-service
    command: ["./api"]
    networks:
      - internal_network
    ports:
      - 8081:8080
    volumes:
      - /home/ubuntu/deploy/path-to-firebase-adminsdk.json:/app/path-to-firebase-adminsdk.json
    environment:
      <<: *shared-env
      OTEL_RESOURCE_ATTRIBUTES: service.name=librarease-api,service.namespace=librarease,deployment.environment=development
    depends_on: 
      - db 
      - redis

  worker-service:
    restart: always
    image: ecr-repo-url/libraraease:backend
    container_name: worker-service
    command: ["./worker"]
    networks:
      - internal_network
    volumes:
      - /home/ubuntu/deploy/path-to-firebase-adminsdk.json:/app/path-to-firebase-adminsdk.json
    environment:
      <<: *shared-env
      WORKER_CONCURRENCY: 10
      OTEL_RESOURCE_ATTRIBUTES: service.name=librarease-api-worker,service.namespace=librarease,deployment.environment=development
    depends_on: 
      - db
      - redis

  frontend-service:
    restart: always
    image: ecr-repo-url/libraraease:frontend
    container_name: frontend-service
    networks:
      - internal_network
    ports:
      - 3001:3000

    volumes:
      - /home/ubuntu/deploy/path-to-firebase-adminsdk.json:/app/path-to-firebase-adminsdk.json
    environment:
      - APP_ENV=production
      - LIBRARY_COOKIE_NAME=library
    depends_on:
      - api-service

networks:
  internal_network: